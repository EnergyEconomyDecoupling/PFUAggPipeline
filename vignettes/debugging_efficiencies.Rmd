---
title: "Debugging Efficiencies"
output: rmarkdown::html_vignette
author: Matthew Kuperus Heun
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Debugging Efficiencies}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  # Set several aspects of graph chunks
  fig.retina=4,
  fig.align='center', 
  fig.height=4,
  fig.width=6
)
```

```{r setup, message=FALSE, include=FALSE}
library(devtools)
library(dplyr)
library(ggplot2)
library(MKHthemes)
library(PFUSetup)
library(pins)
library(readxl)
library(tidyr)

eval_psut_chunks <- TRUE
```


## Introduction

As of September 2023, a few countries 
in the CL-PFU Database exhibit 
primary-to-final efficiencies ($\eta_{E,pf}$)
that unexpectedly exceed 100 %. 
Because primary and final data come from the IEA, 
the IEA data need to be investigated.
This vignette digs into the IEA data to look at the problem.
It remains to be seen whether we can solve the issue,
given that the data are not ours. 
But it is worth investigating, nonetheless.
If there is a solution,
this vignette will, in the future,
show reasonable efficiencies. 


## Establish the pinboard

First, we need to establish the pinboard for the CL-PFU Database.

```{r}
# Create the pinboard from the correct Dropbox folder.
pinboard <- PFUSetup::get_abs_paths()[["pipeline_releases_folder"]] |> 
  pins::board_folder(versioned = TRUE)
```


## Problem 1: Efficiency jump

We observe a slight jump in the world final-to-useful efficiency ($\eta_{fu}$)
for the world in 1990, 
around the time of the breakup of the Soviet Union.
One theory for the cause of the jump
is that we are inadvertently including 
the former Soviet Union or 
the former Yugoslavia in the CL-PFU database.
Let's test this theory.

First, we show the problem
by graphing the world's $\eta_{X,fu}$.


```{r}
# Read efficiency data
agg_eta_pfu_data <- pins::pin_read(board = pinboard,
                                   name = "agg_eta_pfu",
                                   version = "20230918T145318Z-2dcf1")
# Graph the world final-to-useful exergy efficiency
agg_eta_pfu_data |> 
  dplyr::filter(Country == "World", 
                Year >= 1971,
                IEAMW == "IEA",
                Energy.type == "X", 
                GrossNet == "Gross", 
                Product.aggregation == "Specified",
                Industry.aggregation == "Specified") |> 
  # Select only the columns of interest to us
  dplyr::select(Country, Energy.type, Year, eta_fu) |> 
  ggplot2::ggplot(mapping = ggplot2::aes(x = Year, y = eta_fu)) +
  ggplot2::geom_line() + 
  ggplot2::geom_vline(xintercept = c(1989, 1990), linewidth = 0.2) +
  ggplot2::scale_y_continuous(limits = c(0, 0.4), breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
  ggplot2::labs(x = NULL, y = expression(eta[X*","*fu])) +
  MKHthemes::xy_theme()
```

Now, let's look into the CL-PFU Database to see if FSU or FYU are present.

```{r, eval=eval_psut_chunks}
psut_data <- pins::pin_read(board = pinboard, 
                            name = "psut", 
                            version = "20230915T185731Z-c48a0")
countries <- psut_data$Country |> 
  unique()
countries
"FSU" %in% countries
"FYG" %in% countries
```

So, neither the Former Soviet Union nor the Former Yugoslavia
are included in the CL-PFU database.
I will sleep better at night!


## Problem 2: $\eta_{E,pf} > 1$

As of September 2023, 
the following graph shows a few countries with efficiencies
greater than 100 %.


```{r}
agg_eta_pf_data_prepred <- agg_eta_pfu_data |> 
  dplyr::filter(IEAMW == "IEA",
                Energy.type == "E", 
                GrossNet == "Net", 
                Product.aggregation == "Specified",
                Industry.aggregation == "Specified") |> 
  dplyr::select(Country, Energy.type, Year, eta_pf)
agg_eta_pf_data_prepred |> 
  ggplot2::ggplot(mapping = ggplot2::aes(x = Year, y = eta_pf, group = Country)) + 
  ggplot2::geom_line(linewidth = 0.1) + 
  ggplot2::geom_hline(yintercept = 1, colour = "red", linewidth = 0.2) +
  ggplot2::scale_y_continuous(limits = c(0, 1.25), breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
  ggplot2::labs(x = NULL, y = expression(eta[E*","*pf])) +
  MKHthemes::xy_theme()  
```


### Countries where $\eta_{pf} > 1$

Let's find out which countries have primary-to-final efficiencies 
greater than 1.

```{r}
# Find the countries where eta_pf > 1
eta_gt_1 <- agg_eta_pf_data_prepred |> 
  dplyr::filter(eta_pf > 1) |> 
  dplyr::arrange(Year)
eta_gt_1
```

### Machine efficiencies when $\eta_{E,pf} > 1$

Load machine efficiency data to examine for any $\eta_i > 1$.

```{r}
eta_i_data <- pins::pin_read(board = pinboard,
                             name = "eta_i",
                             version = "20230913T144420Z-7cc22")
eta_i_filtered <- eta_i_data |> 
  dplyr::filter(Energy.type == "E", Last.stage == "Final", IEAMW == "IEA") |> 
  dplyr::select(Country, Year, eta_i) |>
  dplyr::filter((Country == "ISL" & Year == 1962) | 
                  (Country == "ALB" & Year == 1979) |
                  (Country == "SWZ" & Year %in% c(1995, 1996)) |
                  (Country == "OAMR" & Year >= 2002 & Year <= 2009) |
                  (Country == "OMN" & Year == 2019)) |> 
  tidyr::pivot_longer(cols = "eta_i", names_to = "matnames", values_to = "matvals") |> 
  matsindf::expand_to_tidy() |> 
  dplyr::mutate(
    colnames = NULL, 
    matnames = NULL
  ) |> 
  dplyr::rename(Machine = "rownames", eta_i = matvals)
# How many efficiencies are > 1?
eta_i_gt_1 <- eta_i_filtered |> 
  dplyr::filter(eta_i > 1)
as.data.frame(eta_i_gt_1)
```

These results point to problems with
"Charcoal production plants", 
"Oil refineries", and 
"Transfers".

Output the OAMR energy conversion chain for 2002.

```{r, eval=eval_psut_chunks}
psut_data |> 
  dplyr::filter(Country == "OAMR", 
                Year == 2002,
                Energy.type == "E",
                IEAMW == "IEA", 
                Last.stage == "Final") |> 
  Recca::write_ecc_to_excel(file.path("~", "Desktop", "OAMR2002.xlsx"), overwrite_file = TRUE)
```

As expected, reviewing the OAMR **U** matrix reveals that
Charcoal production plants do not use any energy, 
but they make Charcoal in the **V** matrix. 
To fix this problem, we need to add upstream primary energy 
that will be consumed by Charcoal production plants.
